

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/images/favicon-48.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="xxxxnnxxxx">
  <meta name="keywords" content="">
  
    <meta name="description" content="翻译文章，非常不错的关于比较 Windows补丁的文章，主要是怎么获取补丁文件">
<meta property="og:type" content="article">
<meta property="og:title" content="Windows 补丁的提取和比较">
<meta property="og:url" content="https://xxxxnnxxxx.github.io/2023/07/06/Windows%20%E8%A1%A5%E4%B8%81%E7%9A%84%E6%8F%90%E5%8F%96%E5%92%8C%E6%AF%94%E8%BE%83/index.html">
<meta property="og:site_name" content="xxxxnnxxxx">
<meta property="og:description" content="翻译文章，非常不错的关于比较 Windows补丁的文章，主要是怎么获取补丁文件">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://xxxxnnxxxx.github.io/2023/07/06/Windows%20%E8%A1%A5%E4%B8%81%E7%9A%84%E6%8F%90%E5%8F%96%E5%92%8C%E6%AF%94%E8%BE%83/msupdate-search.png">
<meta property="og:image" content="https://xxxxnnxxxx.github.io/2023/07/06/Windows%20%E8%A1%A5%E4%B8%81%E7%9A%84%E6%8F%90%E5%8F%96%E5%92%8C%E6%AF%94%E8%BE%83/msupdate-variations.png">
<meta property="og:image" content="https://xxxxnnxxxx.github.io/2023/07/06/Windows%20%E8%A1%A5%E4%B8%81%E7%9A%84%E6%8F%90%E5%8F%96%E5%92%8C%E6%AF%94%E8%BE%83/patchdiff-matched-functions.png">
<meta property="og:image" content="https://xxxxnnxxxx.github.io/2023/07/06/Windows%20%E8%A1%A5%E4%B8%81%E7%9A%84%E6%8F%90%E5%8F%96%E5%92%8C%E6%AF%94%E8%BE%83/bindiff-overview.png">
<meta property="og:image" content="https://xxxxnnxxxx.github.io/2023/07/06/Windows%20%E8%A1%A5%E4%B8%81%E7%9A%84%E6%8F%90%E5%8F%96%E5%92%8C%E6%AF%94%E8%BE%83/bindiff-changed-block.png">
<meta property="article:published_time" content="2023-07-06T14:28:00.000Z">
<meta property="article:modified_time" content="2023-07-06T14:46:18.654Z">
<meta property="article:author" content="xxxxnnxxxx">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://xxxxnnxxxx.github.io/2023/07/06/Windows%20%E8%A1%A5%E4%B8%81%E7%9A%84%E6%8F%90%E5%8F%96%E5%92%8C%E6%AF%94%E8%BE%83/msupdate-search.png">
  
  
  
    <meta name="google-site-verification" content="Z6SsvW3r4WIkFz1e9zkKO2f0hFIouf3dUGoW4PNdvnI" />
  
  <title>Windows 补丁的提取和比较 - xxxxnnxxxx</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"xxxxnnxxxx.github.io","root":"/","version":"1.9.5-a","typing":{"enable":false,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', '');
        });
      }
    </script>
  

  

  

  

  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>xxxxnnxxxx</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle">Windows 补丁的提取和比较</span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-07-06 22:28" pubdate>
          2023年7月6日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          33k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          272 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Windows 补丁的提取和比较</h1>
            
            
              <div class="markdown-body">
                
                <p>原文：<a target="_blank" rel="noopener" href="https://wumb0.in/extracting-and-diffing-ms-patches-in-2020.html">Extracting and Diffing Windows Patches in 2020</a></p>
<style>
    .highlight {
        background-color: rgba(255,255,0, 0.5);
    }
</style>

<p>我已经有一段时间没有在这里发布任何东西了！毕竟，个人博客除了多年来被忽视之外还有什么用；）</p>
<p>不管怎样，我在教授 <a target="_blank" rel="noopener" href="https://www.sans.org/cyber-security-courses/advanced-exploit-development-penetration-testers/">SANS SEC760</a> 时一直在运行这个演示，我想我应该把它写下来，以便研究人员稍后在需要时可以回来查看它。将所有这些内容记录在一个地方也很有用，因为有关它的信息似乎分散在整个 Internet 上，就像许多 Windows 主题一样。</p>
<p>那么为什么要关心提取和分析 Windows 补丁呢？补丁不是说修复的bug现在就没用了吗？</p>
<p>要开始思考如何回答这些问题，请考虑一下，即使是一个运行良好且具有适当补丁管理的组织也需要多长时间才能向设备推出补丁。如果您，安全研究人员，可以在补丁发布后的几周内将错误武器化，那么您就可以出售它或在活动中使用它。查找 bug 很困难，但是经过 n 天的研究可以告诉您几乎确切的 bug 位置！这是个好消息。查看补丁的实施方式以及错误的修复位置对于发现 0day 也很有用。多年来，微软不得不在多个地方修复相同（或非常相似）的错误。一个典型的例子是旧的 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/security-updates/securitybulletins/2007/ms07-017">MS07-017</a> 动画光标错误，它实际上是两年前 (<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/security-updates/securitybulletins/2005/ms05-002">MS05-002</a>) 中相同错误的重复，只是一个函数交叉引用。此外，微软可能根本不会修复该漏洞，或者修复可能不完整，就像今年发现的打印后台处理程序错误一样，该错误被 Ionescu 和 Shafir 称为 <a target="_blank" rel="noopener" href="https://windows-internals.com/printdemon-cve-2020-1048/">PrintDemon</a>。原始 CVE 为 <a target="_blank" rel="noopener" href="https://portal.msrc.microsoft.com/en-us/security-guidance/advisory/CVE-2020-1048">CVE-2020-1048</a>，归功于 <a target="_blank" rel="noopener" href="https://safebreach.com/safebreach-labs">SafeBreach 实验室</a> 的 Peleg Hadar 和 Tomer Bar。修复后，Ionescu 被认定为 CVE-2020-1337，该漏洞仍然允许通过检查时间使用时间 (TOC&#x2F;TOU) 错误创建恶意端口，详细信息请参见<a target="_blank" rel="noopener" href="https://twitter.com/aionescu/status/1293283013715951622">此处</a>。所有这些只是想说：是的，值得一看补丁。查看补丁还可以帮助您找到尚未被研究人员彻底分解的新功能，<a target="_blank" rel="noopener" href="https://twitter.com/aionescu/status/1271098369788674051">这些新功能是漏洞研究的主要目标</a>。</p>
<h1 id="如何获取补丁以及Windows补丁包格式"><a href="#如何获取补丁以及Windows补丁包格式" class="headerlink" title="如何获取补丁以及Windows补丁包格式"></a><strong>如何获取补丁以及Windows补丁包格式</strong></h1><p>为了能够分解补丁，您首先需要了解补丁的格式以及如何获取它们。您实际上可能对用于打包补丁的文件格式有些熟悉：<code>.MSU</code>（Microsoft 独立更新）和 <code>.CAB</code>（Cabinet）。所有补丁均作为 Windows Update 的一部分分发到您的设备上，但您仍然可以从 <a target="_blank" rel="noopener" href="https://www.catalog.update.microsoft.com/Home.aspx">Microsoft Update Catolog</a> 下载独立补丁。在这篇文章中，我将拆解 Windows 10 1903 x64 的补丁。很久以前，<span class="highlight">微软将每个月的第二个星期二定为“补丁星期二” </span>，这样补丁管理员就可以随时知道何时需要修复。在大多数情况下，他们坚持在补丁星期二发布更新，偶尔会针对<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/security-updates/SecurityBulletins/2015/ms15-078">非常严重</a>的错误发布紧急补丁。Microsoft 过去提供必须按顺序安装的连续更新包。如今，更新以累积方式提供，这意味着基础版本 (.1) 所需的所有更新都包含在软件包中。这可以进行一些相当大的更新！许多更新都以<code>增量</code>形式分发，这让事情变得更复杂一些。我们将在本文后面深入讨论这一点。</p>
<h2 id="有效浏览-Microsoft-更新目录"><a href="#有效浏览-Microsoft-更新目录" class="headerlink" title="有效浏览 Microsoft 更新目录"></a><strong>有效浏览 Microsoft 更新目录</strong></h2><p>幸运的是，Microsoft 更新目录具有非常好的搜索功能。搜索所需更新的最有效方法是按以下格式搜索：</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">YYYY-MM <span class="hljs-keyword">release</span>-number (<span class="hljs-keyword">x</span><span class="hljs-number">86</span>|<span class="hljs-keyword">x</span><span class="hljs-number">64</span>|ARM<span class="hljs-number">64</span>) cumulative<br></code></pre></td></tr></table></figure>

<p>例如，如果我正在寻找 Windows 10 1903 x64 的 2020 年 7 月补丁集，我将搜索 2020-07 1903 x64 累积，并且最热门的点击之一应该是我正在寻找的结果。</p>
<p><img src="/2023/07/06/Windows%20%E8%A1%A5%E4%B8%81%E7%9A%84%E6%8F%90%E5%8F%96%E5%92%8C%E6%AF%94%E8%BE%83/msupdate-search.png" srcset="/img/loading.gif" lazyload alt="Relevant results are easy to get with the right search!"></p>
<p>如您所见，返回了几个不同版本号（1903、1909 和 2004）以及 Windows 10 和 Windows Server 的结果。敏锐的观察者应该注意到，Windows Server 和 Windows 10 更新的大小完全相同。事实上，如果您单击下载，两个链接都会定向到同一个地方。此外，1903和1909的更新也是相同的。后一种情况的原因在操作系统<a target="_blank" rel="noopener" href="https://support.microsoft.com/en-us/help/4565483">构建页面</a>上进行了解释：</p>
<pre><code class="hljs">Windows 10 版本 1903 和 1909 共享一个通用的核心操作系统和一组相同的系统文件。因此，Windows 10 版本 1909 中的新功能包含在最近的 Windows 10 版本 1903 每月质量更新（2019 年 10 月 8 日发布）中，但目前处于休眠状态。这些新功能将保持休眠状态，直到使用启用包打开它们，启用包是一个小型、快速安装的“主开关”，只需激活 Windows 10 版本 1909 功能即可。
</code></pre>
<h2 id="动态和服务堆栈更新"><a href="#动态和服务堆栈更新" class="headerlink" title="动态和服务堆栈更新"></a><strong>动态和服务堆栈更新</strong></h2><p>Microsoft 还通过 Microsoft 更新目录分发一些其他类型的更新。如果您在上面的搜索中省略“<code>cumulative(累积)</code>”一词，那么您会得到更多结果，包括比累积更新小得多的 <code>Dynamic(动态)</code> 和 <code>Servicing Stack(服务堆栈)</code> 更新。</p>
<p><img src="/2023/07/06/Windows%20%E8%A1%A5%E4%B8%81%E7%9A%84%E6%8F%90%E5%8F%96%E5%92%8C%E6%AF%94%E8%BE%83/msupdate-variations.png" srcset="/img/loading.gif" lazyload alt="Different Kinds of Updates"></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/deployment/update/servicing-stack-updates">根据 Microsoft 文档</a>，服务堆栈更新是对 Windows 更新过程本身的更新。服务堆栈更新像累积更新一样打包，并且仅包含与 Windows Update 相关的组件。</p>
<p><a target="_blank" rel="noopener" href="https://techcommunity.microsoft.com/t5/windows-it-pro-blog/the-benefits-of-windows-10-dynamic-update/ba-p/467847">Microsoft 文档</a> 再次为动态更新节省了时间，这显然还可以更新 Windows 更新组件，以及安装介质、Windows 恢复环境 (WinRE) 和一些驱动程序等安装组件。<span class="highlight"> 动态更新的打包方式与累积更新和服务堆栈更新略有不同；它们可以作为单个 CAB 文件下载，并具有各种语言包和其他安装组件</span>。</p>
<h1 id="提取补丁"><a href="#提取补丁" class="headerlink" title="提取补丁"></a><strong>提取补丁</strong></h1><p>补丁被紧密地打包到一个 MSU 文件中，该文件可以包含数以万计的文件，其中只有一些文件对我们作为安全研究人员来说很重要。我想首先完成手动提取，然后提供对现有脚本 (<code>PatchExtract.ps1</code>) 的更新，以自动提取和排序给定的补丁。</p>
<h2 id="手动提取"><a href="#手动提取" class="headerlink" title="手动提取"></a><strong>手动提取</strong></h2><p>首先，您需要从更新目录下载累积更新 MSU 文件。在本示例中，我使用 Windows 10 1903 x64 2020 年 8 月累积更新包。我通常在开始之前创建几个文件夹：我用补丁年份和月份命名顶级文件夹，然后创建两个子文件夹，分别称为 <code>patch</code> 和 <code>ext</code>。嵌套 CAB 文件内的实际补丁文件将放入 patch 文件夹中，解压的 MSU 的内容将放入 ext 文件夹中。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs powershell">mkdir <span class="hljs-number">2020</span><span class="hljs-literal">-08</span><br><span class="hljs-built_in">mv</span> <span class="hljs-string">&quot;.\windows10.0-kb4565351-x64_e4f46f54ab78b4dd2dcef193ed573737661e5a10.msu&quot;</span> .\<span class="hljs-number">2020</span><span class="hljs-literal">-08</span>\<br><span class="hljs-built_in">cd</span> .\<span class="hljs-number">2020</span><span class="hljs-literal">-08</span>\<br>mkdir ext<br>mkdir patch<br></code></pre></td></tr></table></figure>

<p>接下来，我将使用 <code>Expand.exe</code> 命令提取 <code>MSU</code>。 Expand 的参数可以使用 <code>/?</code> 选项获取详细说明。出于我们的目的，我们将提取每个文件，因此我们将使用 <code>-F:*</code>。如果您只需要某些类型的文件（CAB、DLL、EXE 等），那么您可以使用 <code>-F</code> 标志来实现。接下来的两个参数是要提取的 MSU，然后是扩展文件的目标文件夹。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell">expand.exe <span class="hljs-operator">-F</span>:* <span class="hljs-string">&quot;.\windows10.0-kb4565351-x64_e4f46f54ab78b4dd2dcef193ed573737661e5a10.msu&quot;</span> .\ext\<br></code></pre></td></tr></table></figure>
<p>最后，我将再次使用 <code>expand</code> 命令从PSFX cab文件中提取补丁文件，这次扩展到 <code>patch</code> 目录。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell">expand.exe <span class="hljs-operator">-F</span>:* <span class="hljs-string">&quot;.\ext\Windows10.0-KB4565351-x64_PSFX.cab&quot;</span> .\patch\ | <span class="hljs-built_in">Out-Null</span><br></code></pre></td></tr></table></figure>

<p>此时我建议走开，开始洗一堆衣服，买一个三明治，然后抚摸猫，因为这部分需要一段时间（10-20 分钟）。<code>Out-Null</code> 是可选的，我只使用它，因为我不关心它打印要提取的每个文件。这种特殊的提取大约需要 15 分钟（通过 <code>Measure-Command</code>），并在 <code>patch</code> 文件夹下总共产生了 <code>78898</code> 个文件和文件夹！</p>
<p>如果你在家也跟着做： 提取完成后，给自己鼓掌，然后收回它，因为不幸的是，这是最容易的部分！</p>
<p>接下来，您必须理解提取的文件并找到您正在寻找的修补文件。</p>
<h2 id="理解提取的文件"><a href="#理解提取的文件" class="headerlink" title="理解提取的文件"></a><strong>理解提取的文件</strong></h2><p>要找到您要查找的内容，了解补丁的结构以及您将遇到的文件类型会有所帮助。</p>
<p>要开始了解这些细节，请看一下从 MSU 开始的补丁的层次结构视图（输出缩写以节省空间）：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs stylus">windows10.<span class="hljs-number">0</span>-kb4565351-x64_e4f46f54ab78b4dd2dcef193ed573737661e5a10<span class="hljs-selector-class">.msu</span><br>├── WSUSSCAN<span class="hljs-selector-class">.cab</span><br>├── Windows10.<span class="hljs-number">0</span>-KB4565351-x64-pkgProperties_PSFX<span class="hljs-selector-class">.txt</span><br>├── Windows10.<span class="hljs-number">0</span>-KB4565351-x64_PSFX<span class="hljs-selector-class">.xml</span><br>└── Windows10.<span class="hljs-number">0</span>-KB4565351-x64_PSFX<span class="hljs-selector-class">.cab</span><br>    ├── amd64_microsoft<span class="hljs-selector-class">.windows</span><span class="hljs-selector-class">.gdiplus_6595b64144ccf1df_1</span>.<span class="hljs-number">0.18362</span>.<span class="hljs-number">1016</span>_none_e013babca5ee7b0b<br>    │   └── gdiplus<span class="hljs-selector-class">.dll</span><br>    ├── amd64_microsoft-windows-os-kernel_31bf3856ad364e35_10.<span class="hljs-number">0.18362</span>.<span class="hljs-number">1016</span>_none_79ea293316ee3bad<br>    │   ├── f<br>    │   │   └── ntoskrnl<span class="hljs-selector-class">.exe</span><br>    │   └── r<br>    │       └── ntoskrnl<span class="hljs-selector-class">.exe</span><br>    ├── msil_microsoft<span class="hljs-selector-class">.hyperv</span><span class="hljs-selector-class">.powershell</span><span class="hljs-selector-class">.cmdlets_31bf3856ad364e35_10</span>.<span class="hljs-number">0.18362</span>.<span class="hljs-number">959</span>_none_a7668eee2055cacf<br>    │   ├── f<br>    │   │   └── microsoft<span class="hljs-selector-class">.hyperv</span><span class="hljs-selector-class">.powershell</span><span class="hljs-selector-class">.cmdlets</span><span class="hljs-selector-class">.dll</span><br>    │   └── r<br>    │       └── microsoft<span class="hljs-selector-class">.hyperv</span><span class="hljs-selector-class">.powershell</span><span class="hljs-selector-class">.cmdlets</span><span class="hljs-selector-class">.dll</span><br>    ├── wow64_microsoft-windows-<span class="hljs-selector-tag">p</span>.<span class="hljs-selector-class">.ting-spooler-client_31bf3856ad364e35_10</span>.<span class="hljs-number">0.18362</span>.<span class="hljs-number">693</span>_none_f3229700ded2ae02<br>    │   ├── f<br>    │   │   └── winspool<span class="hljs-selector-class">.drv</span><br>    │   └── r<br>    │       └── winspool<span class="hljs-selector-class">.drv</span><br>    ├── x86_microsoft-windows-win32calc<span class="hljs-selector-class">.resources_31bf3856ad364e35_10</span>.<span class="hljs-number">0.18362</span>.<span class="hljs-number">387</span>_ar-sa_38566bf3d86fbe5c<br>    │   ├── f<br>    │   │   └── win32calc<span class="hljs-selector-class">.exe</span><span class="hljs-selector-class">.mui</span><br>    │   └── r<br>    │       └── win32calc<span class="hljs-selector-class">.exe</span><span class="hljs-selector-class">.mui</span><br>    ├── amd64_windows-shield-provider_31bf3856ad364e35_10.<span class="hljs-number">0.18362</span>.<span class="hljs-number">900</span>_none_fbf40d7d5ed8b490<br>    │   ├── f<br>    │   │   ├── featuretoastbulldogimg<span class="hljs-selector-class">.png</span><br>    │   │   ├── securityhealthagent<span class="hljs-selector-class">.dll</span><br>    │   │   ├── securityhealthhost<span class="hljs-selector-class">.exe</span><br>    │   │   ├── securityhealthproxystub<span class="hljs-selector-class">.dll</span><br>    │   │   ├── securityhealthservice<span class="hljs-selector-class">.exe</span><br>    │   │   ├── windowsdefendersecuritycenter<span class="hljs-selector-class">.admx</span><br>    │   │   └── windowssecurityicon<span class="hljs-selector-class">.png</span><br>    │   ├── n<br>    │   │   └── featuretoastdlpimg<span class="hljs-selector-class">.png</span><br>    │   └── r<br>    │       ├── featuretoastbulldogimg<span class="hljs-selector-class">.png</span><br>    │       ├── securityhealthagent<span class="hljs-selector-class">.dll</span><br>    │       ├── securityhealthhost<span class="hljs-selector-class">.exe</span><br>    │       ├── securityhealthproxystub<span class="hljs-selector-class">.dll</span><br>    │       ├── securityhealthservice<span class="hljs-selector-class">.exe</span><br>    │       ├── windowsdefendersecuritycenter<span class="hljs-selector-class">.admx</span><br>    │       └── windowssecurityicon<span class="hljs-selector-class">.png</span><br>    ├── microsoft-windows-kernel-feature-package~<span class="hljs-number">31</span>bf3856ad364e35~amd64~~<span class="hljs-number">10.0</span>.<span class="hljs-number">18362.1016</span><span class="hljs-selector-class">.cat</span><br>    ├── microsoft-windows-kernel-feature-package~<span class="hljs-number">31</span>bf3856ad364e35~amd64~~<span class="hljs-number">10.0</span>.<span class="hljs-number">18362.1016</span><span class="hljs-selector-class">.mum</span><br>    ├── amd64_microsoft-windows-os-kernel_31bf3856ad364e35_10.<span class="hljs-number">0.18362</span>.<span class="hljs-number">1016</span>_none_79ea293316ee3bad<span class="hljs-selector-class">.manifest</span><br>    ├── amd64_microsoft<span class="hljs-selector-class">.windows</span><span class="hljs-selector-class">.gdiplus_6595b64144ccf1df_1</span>.<span class="hljs-number">0.18362</span>.<span class="hljs-number">1016</span>_none_e013babca5ee7b0b<span class="hljs-selector-class">.manifest</span><br>    ├── msil_microsoft<span class="hljs-selector-class">.hyperv</span><span class="hljs-selector-class">.powershell</span><span class="hljs-selector-class">.cmdlets_31bf3856ad364e35_10</span>.<span class="hljs-number">0.18362</span>.<span class="hljs-number">959</span>_none_a7668eee2055cacf<span class="hljs-selector-class">.manifest</span><br>    ├── wow64_microsoft-windows-<span class="hljs-selector-tag">p</span>.<span class="hljs-selector-class">.ting-spooler-client_31bf3856ad364e35_10</span>.<span class="hljs-number">0.18362</span>.<span class="hljs-number">693</span>_none_f3229700ded2ae02<span class="hljs-selector-class">.manifest</span><br>    ├── amd64_windows-shield-provider_31bf3856ad364e35_10.<span class="hljs-number">0.18362</span>.<span class="hljs-number">900</span>_none_fbf40d7d5ed8b490<span class="hljs-selector-class">.manifest</span><br>    └── x86_microsoft-windows-win32calc<span class="hljs-selector-class">.resources_31bf3856ad364e35_10</span>.<span class="hljs-number">0.18362</span>.<span class="hljs-number">387</span>_ar-sa_38566bf3d86fbe5c.manifest<br></code></pre></td></tr></table></figure>

<p>正如您在上面看到的，有许多不同的文件格式和文件夹类型：</p>
<ul>
<li><p>文件夹类型</p>
<ul>
<li><p>平台 - 更新中的所有文件夹都将以其中之一为前缀</p>
<ul>
<li><code>amd64</code> - 64-bit x86</li>
<li><code>x86</code> - 32-bit x86</li>
<li><code>wow64</code> - Windows (32-bit) On Windows 64-bit</li>
<li><code>msil</code> - Microsoft Intermediate Language (.NET)</li>
</ul>
</li>
<li><p>差异文件夹</p>
<ul>
<li><code>n</code> - Null differentials(无差异)</li>
<li><code>r</code> - Reverse differentials(向后差异)</li>
<li><code>f</code> - Forward differentials(向前差异)</li>
</ul>
</li>
</ul>
</li>
<li><p>文件类型</p>
<ul>
<li><code>manifest</code> -（几乎）1-1 与平台文件夹配对, 这些是 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/sbscs/manifest-files-reference">Windows Side-by-Side (WinSxS) 清单</a></li>
<li><code>cat</code> - security catalog</li>
<li><code>mum</code> - 1-1 paired with a .cat file and conatins metadata about the part of the update package that the security catalog applies to(1-1 与 .cat 文件配对，包含有关安全目录适用的更新包部分的元数据)</li>
</ul>
</li>
</ul>
<p>平台文件夹和清单实际上与 WinSxS 有关，因为系统可能在 <code>C:\Windows\WinSxS</code> 文件夹中存储二进制文件的多个版本以及差异文件。请注意，这些文件夹中不仅仅有 EXE 和 DLL。还有 PNG 和 MUI 文件。任何类型的文件都可以通过 Windows Update 和 WinSxS 进行更新。一些文件夹名称已被截断；看起来最大文件夹名称长度是100个字符，中间多余的字符被替换为<code>..</code></p>
<p>出于本文的目的，我将保留 .mum 和 .cat 文件，因为它们本质上只是元数据和签名验证信息。</p>
<h3 id="WinSxS-Manifests"><a href="#WinSxS-Manifests" class="headerlink" title="WinSxS Manifests"></a><strong>WinSxS Manifests</strong></h3><p>补丁中的 <code>.manifest</code> 文件<span class="highlight">描述了如何应用补丁、补丁中包含的文件、文件哈希形式的补丁的预期结果、结果文件的权限、要设置的注册表项以及更多的</span>。它们定义了除了替换正在更新的文件之外对系统产生的影响。</p>
<p>以下是 <code>Windows-Gaming-XboxLive-Storage-Service-Component</code>（无论是什么）的示例清单。</p>
<p>▼ amd64_windows-gaming-xbox..e-service-component_31bf3856ad364e35_10.0.18362.836_none_a949879e457dbcd4.manifest</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span> standalone=<span class="hljs-string">&quot;yes&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">assembly</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;urn:schemas-microsoft-com:asm.v3&quot;</span> <span class="hljs-attr">manifestVersion</span>=<span class="hljs-string">&quot;1.0&quot;</span> <span class="hljs-attr">copyright</span>=<span class="hljs-string">&quot;Copyright (c) Microsoft Corporation. All Rights Reserved.&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">assemblyIdentity</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;Windows-Gaming-XboxLive-Storage-Service-Component&quot;</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;10.0.18362.836&quot;</span> <span class="hljs-attr">processorArchitecture</span>=<span class="hljs-string">&quot;amd64&quot;</span> <span class="hljs-attr">language</span>=<span class="hljs-string">&quot;neutral&quot;</span> <span class="hljs-attr">buildType</span>=<span class="hljs-string">&quot;release&quot;</span> <span class="hljs-attr">publicKeyToken</span>=<span class="hljs-string">&quot;31bf3856ad364e35&quot;</span> <span class="hljs-attr">versionScope</span>=<span class="hljs-string">&quot;nonSxS&quot;</span> /&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span> <span class="hljs-attr">discoverable</span>=<span class="hljs-string">&quot;no&quot;</span> <span class="hljs-attr">resourceType</span>=<span class="hljs-string">&quot;resources&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependentAssembly</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">assemblyIdentity</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;Windows-Gaming-XboxLive-Storage-Service-Component.Resources&quot;</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;10.0.18362.836&quot;</span> <span class="hljs-attr">processorArchitecture</span>=<span class="hljs-string">&quot;amd64&quot;</span> <span class="hljs-attr">language</span>=<span class="hljs-string">&quot;*&quot;</span> <span class="hljs-attr">buildType</span>=<span class="hljs-string">&quot;release&quot;</span> <span class="hljs-attr">publicKeyToken</span>=<span class="hljs-string">&quot;31bf3856ad364e35&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependentAssembly</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">file</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;XblGameSave.dll&quot;</span> <span class="hljs-attr">destinationPath</span>=<span class="hljs-string">&quot;$(runtime.system32)\&quot;</span> <span class="hljs-attr">sourceName</span>=<span class="hljs-string">&quot;XblGameSave.dll&quot;</span> <span class="hljs-attr">importPath</span>=<span class="hljs-string">&quot;$(build.nttree)\&quot;</span> <span class="hljs-attr">sourcePath</span>=<span class="hljs-string">&quot;.\&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">securityDescriptor</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;WRP_FILE_DEFAULT_SDDL&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">asmv2:hash</span> <span class="hljs-attr">xmlns:asmv2</span>=<span class="hljs-string">&quot;urn:schemas-microsoft-com:asm.v2&quot;</span> <span class="hljs-attr">xmlns:dsig</span>=<span class="hljs-string">&quot;http://www.w3.org/2000/09/xmldsig#&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">dsig:Transforms</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dsig:Transform</span> <span class="hljs-attr">Algorithm</span>=<span class="hljs-string">&quot;urn:schemas-microsoft-com:HashTransforms.Identity&quot;</span> /&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">dsig:Transforms</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">dsig:DigestMethod</span> <span class="hljs-attr">Algorithm</span>=<span class="hljs-string">&quot;http://www.w3.org/2000/09/xmldsig#sha256&quot;</span> /&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">dsig:DigestValue</span>&gt;</span>VjbzeELS2YXIwIhHo5f2hQm+pWTzHY8wo7dFxzfkbtA=<span class="hljs-tag">&lt;/<span class="hljs-name">dsig:DigestValue</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">asmv2:hash</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">file</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">file</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;XblGameSaveTask.exe&quot;</span> <span class="hljs-attr">destinationPath</span>=<span class="hljs-string">&quot;$(runtime.system32)\&quot;</span> <span class="hljs-attr">sourceName</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">importPath</span>=<span class="hljs-string">&quot;$(build.nttree)\&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">securityDescriptor</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;WRP_FILE_DEFAULT_SDDL&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">asmv2:hash</span> <span class="hljs-attr">xmlns:asmv2</span>=<span class="hljs-string">&quot;urn:schemas-microsoft-com:asm.v2&quot;</span> <span class="hljs-attr">xmlns:dsig</span>=<span class="hljs-string">&quot;http://www.w3.org/2000/09/xmldsig#&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">dsig:Transforms</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dsig:Transform</span> <span class="hljs-attr">Algorithm</span>=<span class="hljs-string">&quot;urn:schemas-microsoft-com:HashTransforms.Identity&quot;</span> /&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">dsig:Transforms</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">dsig:DigestMethod</span> <span class="hljs-attr">Algorithm</span>=<span class="hljs-string">&quot;http://www.w3.org/2000/09/xmldsig#sha256&quot;</span> /&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">dsig:DigestValue</span>&gt;</span>Ez9Rg7QMg26whoQcakH4i15oeH1NOZgbybxRdPMoi8Q=<span class="hljs-tag">&lt;/<span class="hljs-name">dsig:DigestValue</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">asmv2:hash</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">file</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">memberships</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">categoryMembership</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;Microsoft.Windows.Categories.Services&quot;</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;10.0.18362.836&quot;</span> <span class="hljs-attr">publicKeyToken</span>=<span class="hljs-string">&quot;31bf3856ad364e35&quot;</span> <span class="hljs-attr">typeName</span>=<span class="hljs-string">&quot;Service&quot;</span> /&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">categoryInstance</span> <span class="hljs-attr">subcategory</span>=<span class="hljs-string">&quot;XblGameSave&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">serviceData</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;XblGameSave&quot;</span> <span class="hljs-attr">displayName</span>=<span class="hljs-string">&quot;@%systemroot%\system32\XblGameSave.dll,-100&quot;</span> <span class="hljs-attr">errorControl</span>=<span class="hljs-string">&quot;normal&quot;</span> <span class="hljs-attr">start</span>=<span class="hljs-string">&quot;demand&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;win32ShareProcess&quot;</span> <span class="hljs-attr">description</span>=<span class="hljs-string">&quot;@%systemroot%\system32\XblGameSave.dll,-101&quot;</span> <span class="hljs-attr">dependOnService</span>=<span class="hljs-string">&quot;UserManager,XblAuthManager&quot;</span> <span class="hljs-attr">imagePath</span>=<span class="hljs-string">&quot;%SystemRoot%\system32\svchost.exe -k netsvcs -p&quot;</span> <span class="hljs-attr">objectName</span>=<span class="hljs-string">&quot;LocalSystem&quot;</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">failureActions</span> <span class="hljs-attr">resetPeriod</span>=<span class="hljs-string">&quot;86400&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">actions</span>&gt;</span><br>              <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">delay</span>=<span class="hljs-string">&quot;10000&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;restartService&quot;</span> /&gt;</span><br>              <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">delay</span>=<span class="hljs-string">&quot;10000&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;restartService&quot;</span> /&gt;</span><br>              <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">delay</span>=<span class="hljs-string">&quot;10000&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;restartService&quot;</span> /&gt;</span><br>              <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">delay</span>=<span class="hljs-string">&quot;0&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;none&quot;</span> /&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">actions</span>&gt;</span><br>          <span class="hljs-tag">&lt;/<span class="hljs-name">failureActions</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">serviceTrigger</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;start&quot;</span> <span class="hljs-attr">subtype</span>=<span class="hljs-string">&quot;RPC_INTERFACE_EVENT&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;NetworkEndpointEvent&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">triggerData</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;string&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;F6C98708-C7B8-4919-887C-2CE66E78B9A0&quot;</span> /&gt;</span><br>          <span class="hljs-tag">&lt;/<span class="hljs-name">serviceTrigger</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">serviceData</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">categoryInstance</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">categoryMembership</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">categoryMembership</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;Microsoft.Windows.Categories&quot;</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0.0.0&quot;</span> <span class="hljs-attr">publicKeyToken</span>=<span class="hljs-string">&quot;365143bb27e7ac8b&quot;</span> <span class="hljs-attr">typeName</span>=<span class="hljs-string">&quot;BootRecovery&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">categoryMembership</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">categoryMembership</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;Microsoft.Windows.Categories&quot;</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0.0.0&quot;</span> <span class="hljs-attr">publicKeyToken</span>=<span class="hljs-string">&quot;365143bb27e7ac8b&quot;</span> <span class="hljs-attr">typeName</span>=<span class="hljs-string">&quot;SvcHost&quot;</span> /&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">categoryInstance</span> <span class="hljs-attr">subcategory</span>=<span class="hljs-string">&quot;netsvcs&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">serviceGroup</span> <span class="hljs-attr">position</span>=<span class="hljs-string">&quot;last&quot;</span> <span class="hljs-attr">serviceName</span>=<span class="hljs-string">&quot;XblGameSave&quot;</span> /&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">categoryInstance</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">categoryMembership</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">memberships</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">taskScheduler</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Task</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://schemas.microsoft.com/windows/2004/02/mit/task&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">RegistrationInfo</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">Author</span>&gt;</span>Microsoft<span class="hljs-tag">&lt;/<span class="hljs-name">Author</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">Description</span>&gt;</span>XblGameSave Standby Task<span class="hljs-tag">&lt;/<span class="hljs-name">Description</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">URI</span>&gt;</span>\Microsoft\XblGameSave\XblGameSaveTask<span class="hljs-tag">&lt;/<span class="hljs-name">URI</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">RegistrationInfo</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">Principals</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">Principal</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;LocalSystem&quot;</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">UserId</span>&gt;</span>S-1-5-18<span class="hljs-tag">&lt;/<span class="hljs-name">UserId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">Principal</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">Principals</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">Triggers</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">IdleTrigger</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;XblGameSave Check on CS Entry&quot;</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">Enabled</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">Enabled</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">IdleTrigger</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">Triggers</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">Settings</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">MultipleInstancesPolicy</span>&gt;</span>IgnoreNew<span class="hljs-tag">&lt;/<span class="hljs-name">MultipleInstancesPolicy</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">DisallowStartIfOnBatteries</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">DisallowStartIfOnBatteries</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">StopIfGoingOnBatteries</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">StopIfGoingOnBatteries</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">AllowHardTerminate</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">AllowHardTerminate</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">StartWhenAvailable</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">StartWhenAvailable</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">RunOnlyIfNetworkAvailable</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">RunOnlyIfNetworkAvailable</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">AllowStartOnDemand</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">AllowStartOnDemand</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">Enabled</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">Enabled</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">Hidden</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">Hidden</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">RunOnlyIfIdle</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">RunOnlyIfIdle</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">WakeToRun</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">WakeToRun</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">ExecutionTimeLimit</span>&gt;</span>PT2H<span class="hljs-tag">&lt;/<span class="hljs-name">ExecutionTimeLimit</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">Priority</span>&gt;</span>7<span class="hljs-tag">&lt;/<span class="hljs-name">Priority</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">Settings</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">Actions</span> <span class="hljs-attr">Context</span>=<span class="hljs-string">&quot;LocalSystem&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">Exec</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">Command</span>&gt;</span>%windir%\System32\XblGameSaveTask.exe<span class="hljs-tag">&lt;/<span class="hljs-name">Command</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">Arguments</span>&gt;</span>standby<span class="hljs-tag">&lt;/<span class="hljs-name">Arguments</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">Exec</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">Actions</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">Task</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">taskScheduler</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">registryKeys</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">registryKey</span> <span class="hljs-attr">keyName</span>=<span class="hljs-string">&quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Ubpm&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">registryValue</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;CriticalTask_XblGameSaveTask&quot;</span> <span class="hljs-attr">valueType</span>=<span class="hljs-string">&quot;REG_SZ&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;NT TASK\Microsoft\XblGameSave\XblGameSaveTask&quot;</span> /&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">registryValue</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;CriticalTask_XblGameSaveTaskLogon&quot;</span> <span class="hljs-attr">valueType</span>=<span class="hljs-string">&quot;REG_SZ&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;NT TASK\Microsoft\XblGameSave\XblGameSaveTaskLogon&quot;</span> /&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">securityDescriptor</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;WRP_REGKEY_DEFAULT_SDDL&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">registryKey</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">registryKey</span> <span class="hljs-attr">keyName</span>=<span class="hljs-string">&quot;HKEY_CLASSES_ROOT\AppId\&#123;C5D3C0E1-DC41-4F83-8BA8-CC0D46BCCDE3&#125;&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">registryValue</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">valueType</span>=<span class="hljs-string">&quot;REG_SZ&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;Xbox Live Game Saves&quot;</span> /&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">registryValue</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;LocalService&quot;</span> <span class="hljs-attr">valueType</span>=<span class="hljs-string">&quot;REG_SZ&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;XblGameSave&quot;</span> /&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">registryValue</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;AccessPermission&quot;</span> <span class="hljs-attr">valueType</span>=<span class="hljs-string">&quot;REG_BINARY&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;010014806400000070000000140000003000000002001c000100000011001400040000000101000000000010001000000200340002000000000018001f000000010200000000000f0200000001000000000014001f00000001010000000000010000000001010000000000050a00000001020000000000052000000021020000&quot;</span> /&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">registryValue</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;LaunchPermission&quot;</span> <span class="hljs-attr">valueType</span>=<span class="hljs-string">&quot;REG_BINARY&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;010014806400000070000000140000003000000002001c000100000011001400040000000101000000000010001000000200340002000000000018001f000000010200000000000f0200000001000000000014001f00000001010000000000010000000001010000000000050a00000001020000000000052000000021020000&quot;</span> /&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">securityDescriptor</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;WRP_REGKEY_DEFAULT_SDDL&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">registryKey</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">registryKey</span> <span class="hljs-attr">keyName</span>=<span class="hljs-string">&quot;HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\XblGameSave\Parameters&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">registryValue</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;ServiceDll&quot;</span> <span class="hljs-attr">valueType</span>=<span class="hljs-string">&quot;REG_EXPAND_SZ&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;%SystemRoot%\System32\XblGameSave.dll&quot;</span> /&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">registryValue</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;ServiceDllUnloadOnStop&quot;</span> <span class="hljs-attr">valueType</span>=<span class="hljs-string">&quot;REG_DWORD&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;0x00000001&quot;</span> /&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">registryValue</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;ServiceIdleTimeout&quot;</span> <span class="hljs-attr">valueType</span>=<span class="hljs-string">&quot;REG_DWORD&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;0x00000258&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">registryKey</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">registryKey</span> <span class="hljs-attr">keyName</span>=<span class="hljs-string">&quot;HKEY_CLASSES_ROOT\CLSID\&#123;F7FD3FD6-9994-452D-8DA7-9A8FD87AEEF4&#125;\&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">registryValue</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;AppId&quot;</span> <span class="hljs-attr">valueType</span>=<span class="hljs-string">&quot;REG_SZ&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;&#123;C5D3C0E1-DC41-4F83-8BA8-CC0D46BCCDE3&#125;&quot;</span> /&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">securityDescriptor</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;WRP_REGKEY_DEFAULT_SDDL&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">registryKey</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">registryKey</span> <span class="hljs-attr">keyName</span>=<span class="hljs-string">&quot;HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\WindowsRuntime\AllowedCOMCLSIDs\&#123;F7FD3FD6-9994-452D-8DA7-9A8FD87AEEF4&#125;\&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">registryKey</span> <span class="hljs-attr">keyName</span>=<span class="hljs-string">&quot;HKEY_CLASSES_ROOT\CLSID\&#123;5B3E6773-3A99-4A3D-8096-7765DD11785C&#125;\&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">registryValue</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;AppId&quot;</span> <span class="hljs-attr">valueType</span>=<span class="hljs-string">&quot;REG_SZ&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;&#123;C5D3C0E1-DC41-4F83-8BA8-CC0D46BCCDE3&#125;&quot;</span> /&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">securityDescriptor</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;WRP_REGKEY_DEFAULT_SDDL&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">registryKey</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">registryKey</span> <span class="hljs-attr">keyName</span>=<span class="hljs-string">&quot;HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\WindowsRuntime\AllowedCOMCLSIDs\&#123;5B3E6773-3A99-4A3D-8096-7765DD11785C&#125;\&quot;</span> /&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">registryKeys</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">localization</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">resources</span> <span class="hljs-attr">culture</span>=<span class="hljs-string">&quot;en-US&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">stringTable</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">string</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;displayName&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;XblGameSave&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">string</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;description&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;XblGameSave service&quot;</span> /&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">stringTable</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">localization</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">trustInfo</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">security</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">accessControl</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">securityDescriptorDefinitions</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">securityDescriptorDefinition</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;WRP_REGKEY_DEFAULT_SDDL&quot;</span> <span class="hljs-attr">sddl</span>=<span class="hljs-string">&quot;O:S-1-5-80-956008885-3418522649-1831038044-1853292631-2271478464G:S-1-5-80-956008885-3418522649-1831038044-1853292631-2271478464D:P(A;CI;GA;;;S-1-5-80-956008885-3418522649-1831038044-1853292631-2271478464)(A;CI;GR;;;SY)(A;CI;GR;;;BA)(A;CI;GR;;;BU)(A;CI;GR;;;S-1-15-2-1)(A;CI;GR;;;S-1-15-3-1024-1065365936-1281604716-3511738428-1654721687-432734479-3232135806-4053264122-3456934681)&quot;</span> <span class="hljs-attr">operationHint</span>=<span class="hljs-string">&quot;replace&quot;</span> /&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">securityDescriptorDefinition</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;WRP_FILE_DEFAULT_SDDL&quot;</span> <span class="hljs-attr">sddl</span>=<span class="hljs-string">&quot;O:S-1-5-80-956008885-3418522649-1831038044-1853292631-2271478464G:S-1-5-80-956008885-3418522649-1831038044-1853292631-2271478464D:P(A;;FA;;;S-1-5-80-956008885-3418522649-1831038044-1853292631-2271478464)(A;;GRGX;;;BA)(A;;GRGX;;;SY)(A;;GRGX;;;BU)(A;;GRGX;;;S-1-15-2-1)(A;;GRGX;;;S-1-15-2-2)S:(AU;FASA;0x000D0116;;;WD)&quot;</span> <span class="hljs-attr">operationHint</span>=<span class="hljs-string">&quot;replace&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">securityDescriptorDefinitions</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">accessControl</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">security</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">trustInfo</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">assembly</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>注意所有不同的字段。有一些字段可以修改注册表项、更改文件权限、要修补的文件及其生成的哈希值、要修改或更改状态的服务、要添加或更改的计划任务等等！</p>
<p>如果您查看此清单描述的相应平台文件夹，您将找到它所引用的文件，可以是完整文件，也可以是（在本例中）差异文件：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> &gt; <span class="hljs-built_in">ls</span> <span class="hljs-literal">-Recurse</span> amd64_windows<span class="hljs-literal">-gaming-xbox</span>..e<span class="hljs-literal">-service-component_31bf3856ad364e35_10</span>.<span class="hljs-number">0.18362</span>.<span class="hljs-number">836</span>_none_a949879e457dbcd4<br></code></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs powershell">Directory: C:\Users\wumb0\Desktop\patches\<span class="hljs-number">2020</span><span class="hljs-literal">-08</span>\patch\amd64_windows<span class="hljs-literal">-gaming-xbox</span>..e<span class="hljs-literal">-service-component_31bf3856ad36</span><br>    <span class="hljs-number">4</span>e35_10.<span class="hljs-number">0.18362</span>.<span class="hljs-number">836</span>_none_a949879e457dbcd4<br><br><br>Mode                 LastWriteTime         Length Name<br><span class="hljs-literal">----</span>                 <span class="hljs-literal">-------------</span>         <span class="hljs-literal">------</span> <span class="hljs-literal">----</span><br>d<span class="hljs-literal">-----</span>         <span class="hljs-number">8</span>/<span class="hljs-number">23</span>/<span class="hljs-number">2020</span>   <span class="hljs-number">6</span>:<span class="hljs-number">50</span> PM                f<br>d<span class="hljs-literal">-----</span>         <span class="hljs-number">8</span>/<span class="hljs-number">23</span>/<span class="hljs-number">2020</span>   <span class="hljs-number">6</span>:<span class="hljs-number">50</span> PM                <span class="hljs-built_in">r</span><br><br><br>    Directory: C:\Users\wumb0\Desktop\patches\<span class="hljs-number">2020</span><span class="hljs-literal">-08</span>\patch\amd64_windows<span class="hljs-literal">-gaming-xbox</span>..e<span class="hljs-literal">-service-component_31bf3856ad36</span><br>    <span class="hljs-number">4</span>e35_10.<span class="hljs-number">0.18362</span>.<span class="hljs-number">836</span>_none_a949879e457dbcd4\f<br><br><br>Mode                 LastWriteTime         Length Name<br><span class="hljs-literal">----</span>                 <span class="hljs-literal">-------------</span>         <span class="hljs-literal">------</span> <span class="hljs-literal">----</span><br><span class="hljs-literal">-a----</span>          <span class="hljs-number">8</span>/<span class="hljs-number">6</span>/<span class="hljs-number">2020</span>   <span class="hljs-number">5</span>:<span class="hljs-number">10</span> AM          <span class="hljs-number">35111</span> xblgamesave.dll<br><span class="hljs-literal">-a----</span>          <span class="hljs-number">8</span>/<span class="hljs-number">6</span>/<span class="hljs-number">2020</span>   <span class="hljs-number">5</span>:<span class="hljs-number">10</span> AM            <span class="hljs-number">237</span> xblgamesavetask.exe<br><br><br>    Directory: C:\Users\wumb0\Desktop\patches\<span class="hljs-number">2020</span><span class="hljs-literal">-08</span>\patch\amd64_windows<span class="hljs-literal">-gaming-xbox</span>..e<span class="hljs-literal">-service-component_31bf3856ad36</span><br>    <span class="hljs-number">4</span>e35_10.<span class="hljs-number">0.18362</span>.<span class="hljs-number">836</span>_none_a949879e457dbcd4\r<br><br><br>Mode                 LastWriteTime         Length Name<br><span class="hljs-literal">----</span>                 <span class="hljs-literal">-------------</span>         <span class="hljs-literal">------</span> <span class="hljs-literal">----</span><br><span class="hljs-literal">-a----</span>          <span class="hljs-number">8</span>/<span class="hljs-number">6</span>/<span class="hljs-number">2020</span>   <span class="hljs-number">5</span>:<span class="hljs-number">10</span> AM          <span class="hljs-number">35200</span> xblgamesave.dll<br><span class="hljs-literal">-a----</span>          <span class="hljs-number">8</span>/<span class="hljs-number">6</span>/<span class="hljs-number">2020</span>   <span class="hljs-number">5</span>:<span class="hljs-number">10</span> AM            <span class="hljs-number">237</span> xblgamesavetask.exe<br></code></pre></td></tr></table></figure>

<p>注：<code>ls -Recurse</code> 递归显示目录内容</p>
<h2 id="自动补丁提取"><a href="#自动补丁提取" class="headerlink" title="自动补丁提取"></a><strong>自动补丁提取</strong></h2><p>现在您已经了解了补丁的结构以及如何从中提取文件，现在是时候在混合中引入一些自动化了。Greg Linares (@laughing_mantis) 是 <a target="_blank" rel="noopener" href="https://twitter.com/laughing_mantis/status/842100719385698305">Patch Extract</a> 的作者，一个自动提取和组织 Microsoft 补丁的工具。他还创建了一个名为 <a target="_blank" rel="noopener" href="https://twitter.com/Laughing_Mantis/status/789346238122426368">Patch Clean</a> 的工具，但我不确定它是否仍然适用于现代补丁，所以使用后果自负！我稍微修改了 PatchExtract 以修复一些 powershell 问题并安静脚本的输出。请注意，它现在在用户输入字符串上使用 <code>IEX</code>，所以要小心:)。</p>
<p>PatchExtract.ps1:</p>
<script src="https://gist.github.com/wumb0/306f97dc8376c6f53b9f9865f60b4fb5.js"></script>

<p>要使用，请指定 <code>PATCH</code> 的路径和结果文件的输出 <code>PATH</code>。 <code>PatchClean</code> 将提取 MSU，找到 <code>PSFX</code> <code>CAB</code>，提取其内容，并将提取的补丁分类到各个文件夹中：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> &gt; <span class="hljs-built_in">ls</span> X:\Patches\x64\<span class="hljs-number">1903</span>\<span class="hljs-number">2019</span>\<span class="hljs-number">9</span><br><br><br>    Directory: X:\Patches\x64\<span class="hljs-number">1903</span>\<span class="hljs-number">2019</span>\<span class="hljs-number">9</span><br><br><br>Mode                 LastWriteTime         Length Name<br><span class="hljs-literal">----</span>                 <span class="hljs-literal">-------------</span>         <span class="hljs-literal">------</span> <span class="hljs-literal">----</span><br>da<span class="hljs-literal">----</span>         <span class="hljs-number">11</span>/<span class="hljs-number">9</span>/<span class="hljs-number">2019</span>   <span class="hljs-number">6</span>:<span class="hljs-number">30</span> PM                JUNK<br>da<span class="hljs-literal">----</span>         <span class="hljs-number">11</span>/<span class="hljs-number">9</span>/<span class="hljs-number">2019</span>   <span class="hljs-number">6</span>:<span class="hljs-number">30</span> PM                MSIL<br>da<span class="hljs-literal">----</span>         <span class="hljs-number">11</span>/<span class="hljs-number">9</span>/<span class="hljs-number">2019</span>   <span class="hljs-number">6</span>:<span class="hljs-number">32</span> PM                PATCH<br>da<span class="hljs-literal">----</span>         <span class="hljs-number">11</span>/<span class="hljs-number">9</span>/<span class="hljs-number">2019</span>   <span class="hljs-number">6</span>:<span class="hljs-number">31</span> PM                WOW64<br>da<span class="hljs-literal">----</span>         <span class="hljs-number">11</span>/<span class="hljs-number">9</span>/<span class="hljs-number">2019</span>   <span class="hljs-number">7</span>:<span class="hljs-number">06</span> PM                x64<br>da<span class="hljs-literal">----</span>         <span class="hljs-number">11</span>/<span class="hljs-number">9</span>/<span class="hljs-number">2019</span>   <span class="hljs-number">6</span>:<span class="hljs-number">31</span> PM                x86<br><span class="hljs-literal">-a----</span>          <span class="hljs-number">9</span>/<span class="hljs-number">8</span>/<span class="hljs-number">2019</span>  <span class="hljs-number">12</span>:<span class="hljs-number">28</span> PM            <span class="hljs-number">517</span> Windows10.<span class="hljs-number">0</span><span class="hljs-literal">-KB4515384-x64-pkgProperties_PSFX</span>.txt<br></code></pre></td></tr></table></figure>
<p>MSIL、WOW64、x86 和 x64 文件夹将包含所有不同平台文件夹，并删除其前缀。 PATCH 文件夹将包含补丁 MSU 及其内容，但补丁 PSFX 元数据文本文件除外，该文件保留在顶级文件夹的根目录中。最后，JUNK 文件夹中填充了 .manifest 文件以及我们并不真正关心的 .mum 和 .cat 文件。使用此工具可以加快补丁提取过程！</p>
<h3 id="处理提取的补丁"><a href="#处理提取的补丁" class="headerlink" title="处理提取的补丁"></a><strong>处理提取的补丁</strong></h3><p>提取补丁时请注意：始终在本地计算机上进行，压缩结果，然后传输到另一台计算机进行存储。未压缩的解压补丁大约为 1.5 GB，压缩的解压补丁大约为 1 GB。这可以快速填满您的磁盘空间！由于每个补丁中有数万个文件，未压缩的目录结构的传输将需要很长时间。如果您需要搜索压缩补丁，您只需使用 unzip -l 列出内容，然后仅提取您需要的文件。</p>
<h1 id="补丁文件类型"><a href="#补丁文件类型" class="headerlink" title="补丁文件类型"></a><strong>补丁文件类型</strong></h1><h2 id="完整文件"><a href="#完整文件" class="headerlink" title="完整文件"></a><strong>完整文件</strong></h2><p>不含 <code>n</code>、<code>f</code> 或 <code>r</code> 目录的平台文件夹包含要安装的完整文件。修补过程非常简单，只需将该文件夹中的文件复制到相应 <code>.manifest</code> 文件中指定的位置即可。</p>
<p>您如何获得该文件的另一个副本来进行比较？这可能很困难，但您也许可以查看以前的补丁以获取不同的版本。事实证明，差速器实际上是更方便的情况！</p>
<h2 id="补丁增量"><a href="#补丁增量" class="headerlink" title="补丁增量"></a><strong>补丁增量</strong></h2><p>当平台文件夹中包含 <code>n</code>、<code>f</code> 或 <code>r</code> 目录时，补丁是一个增量，它要么应用于现有文件 <code>(r/f)</code>，要么应用于空缓冲区以创建新文件 <code>(n)</code>。微软在今年（2020）年初发布了关于差异化的<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/deployment/update/psfxwhitepaper">白皮书</a>。</p>
<h3 id="增量类型"><a href="#增量类型" class="headerlink" title="增量类型"></a><strong>增量类型</strong></h3><p>如前所述，增量分为三种类型：</p>
<ul>
<li><p><code>Forward differentials (f)</code> - 将基本二进制文件 (.1) 提升到特定补丁级别</p>
</li>
<li><p><code>Reverse differentials (r)</code> - 将应用的补丁恢复为基本二进制文件 (.1)</p>
</li>
<li><p><code>Null differentials (n)</code> - 一个全新的文件，刚刚压缩；应用于空缓冲区以获取完整文件</p>
</li>
</ul>
<p>您将始终在补丁内看到 r 和 f 文件夹，因为您需要能够稍后恢复补丁以应用较新的更新。</p>
<h3 id="Delta-APIs"><a href="#Delta-APIs" class="headerlink" title="Delta APIs"></a><strong>Delta APIs</strong></h3><p>在我开始深入研究 Delta 格式并将其应用于文件之前，值得注意的是 Microsoft 提供了有关 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/previous-versions/bb417345(v=msdn.10)">Delta Compression API</a> 的开发人员文档（稍微过时，但仍然相关）。实际上有两个完全不同的 API 用于创建和应用补丁增量：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/previous-versions/bb417345(v=msdn.10)#patchapi">PatchAPI</a> 和 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/previous-versions/bb417345(v=msdn.10)#msdelta">MSDELTA</a>。在这篇文章中，我将重点关注 MSDELTA API，因为它较新，并且仅在正在发布的新补丁中使用。此外，如果您调用 MSDELTA API 并提供 PatchAPI 修补程序文件，它会识别该文件并通过调用 <code>mspatcha.dll</code> 来应用修补程序。</p>
<p>MSDELTA API 中的函数包含在 msdelta.dll 内。</p>
<ul>
<li><code>CreateDelta(A|W|B)</code> - 从文件 (A|W) 或缓冲区 (B) 创建增量</li>
<li><code>ApplyDelta(A|W|B)</code> - 将增量从文件应用到文件 (A|W) 或从缓冲区 (B) 应用到缓冲区 (B)</li>
<li><code>ApplyDeltaProvidedB</code> - 将缓冲区中的增量应用到被调用者分配的提供的缓冲区（无需调用 <code>DeltaFree</code>）</li>
<li><code>GetDeltaInfo(A|W|B)</code> - 获取有关补丁的元数据并计算增量文件 (A|W) 或缓冲区 (B) 的签名</li>
<li><code>GetDeltaSignature(A|W|B)</code> - 计算增量文件 (A|W) 或缓冲区 (B) 的签名。</li>
<li><code>DeltaNormalizeProvidedB</code> - 将增量缓冲区置于标准状态，以便通过 MSDELTA 不支持的算法进行哈希处理</li>
<li><code>DeltaFree</code> - 释放由 <code>CreateDeltaB</code> 或 <code>ApplyDeltaB</code> 创建的增量缓冲区</li>
</ul>
<p>我将使用 <code>ApplyDeltaB</code> 将多个补丁增量文件应用到文件缓冲区，然后使用 <code>DeltaFree</code> 释放生成的缓冲区。更仔细地查看 <code>GetDeltaInfo*</code> 和 <code>DeltaNormalizeProvidedB</code> 都在我的 TODO 列表中，但对于本文的目的来说并不是那么重要。</p>
<p>MSDELTA API 的其他有趣功能是能够通过文件类型集将增量应用到<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/previous-versions/bb417345(v=msdn.10)#file-type-sets">特定的二进制部分</a>。这些背后还有更多的研究要做！</p>
<h3 id="Delta-Formats"><a href="#Delta-Formats" class="headerlink" title="Delta Formats"></a><strong>Delta Formats</strong></h3><p>乍一看，您会确信补丁内的增量文件夹中的文件是完整的二进制文件，因为它们的扩展名。第一个线索是它们的大小，因为它们比您预期的完整二进制文件要小得多。另一个是文件格式完全不同！在十六进制编辑器中打开一些提取的文件很快就会显示这一点：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs bash">wumb0 <span class="hljs-keyword">in</span> patches$ xxd 2020-08/patch/amd64_microsoft-windows-os-kernel_31bf3856ad364e35_10.0.18362.1016_none_79ea293316ee3bad/f/ntoskrnl.exe | <span class="hljs-built_in">head</span><br>00000000: e45a 9bd5 5041 3330 6e2b 8720 fa6a d601  .Z..PA30n+. .j..<br>00000010: b05e 10d0 c7c4 0cc4 69bc c401 4021 00b4  .^......i...@!..<br>00000020: ab4f 2159 0f6a 2ab4 7848 f5df d9cd 2fb8  .O!Y.j*.xH..../.<br>00000030: b30b 0400 0000 0a00 0000 0000 0000 9836  ...............6<br>00000040: 86a9 cb02 f05b dddd dddd dddd dddd dddd  .....[..........<br>00000050: dd2d 4dd2 333d d143 3dd4 ddd3 0128 c6c4  .-M.3=.C=....(..<br>00000060: cccc cccc cccc cccc c31c 22c2 cccc 3c2c  ..........<span class="hljs-string">&quot;...&lt;,</span><br><span class="hljs-string">00000070: cccc ccc3 7280 3000 d07f 0700 a8ff 1700  ....r.0.........</span><br><span class="hljs-string">00000080: fc7f 00a0 ff03 80fc 5f00 90ff 0c00 ecfc  ........_.......</span><br><span class="hljs-string">00000090: 8701 60e5 ff19 1100 7cff 5f00 f8ff 0080  ..`.....|._.....</span><br><span class="hljs-string"></span><br><span class="hljs-string">wumb0 in patches$ xxd 2020-08/patch/amd64_microsoft-onecore-reverseforwarders_31bf3856ad364e35_10.0.18362.997_none_f7e8eb88fe7a4f39/r/gdi32.dll | head</span><br><span class="hljs-string">00000000: db07 a73a 5041 3330 f494 3566 d8dd d401  ...:PA30..5f....</span><br><span class="hljs-string">00000010: b05e 10d0 c7c4 0c02 6006 0e00 0a01 5d41  .^......`.....]A</span><br><span class="hljs-string">00000020: 1606 6042 f2b4 03a7 1295 36ee fbe7 2e01  ..`B......6.....</span><br><span class="hljs-string">00000030: 0100 0000 0c00 0000 0000 0000 b0b4 5e9e  ..............^.</span><br><span class="hljs-string">00000040: 0802 402d aaaa aaaa aaaa aaaa aaaa aa0a  ..@-............</span><br><span class="hljs-string">00000050: aaaa 2aa2 0117 dba2 aaaa aaaa aaaa aaaa  ..*.............</span><br><span class="hljs-string">00000060: a2a2 111a c900 f87f 03c0 fd17 00e4 ff00  ................</span><br><span class="hljs-string">00000070: f8ff 00d0 3f00 fa1f 00ff 0fd6 00b3 0340  ....?..........@</span><br><span class="hljs-string">00000080: 20ee ea69 7500 00d8 1069 a703 f54e 5d0f   ..iu....i...N].</span><br><span class="hljs-string">00000090: d301 2557 07ec 681d 9a0f caa7 03b5 c81a  ..%W..h.........</span><br><span class="hljs-string"></span><br><span class="hljs-string">wumb0 in patches$ xxd 2020-08/patch/amd64_microsoft-windows-f..ysafety-refreshtask_31bf3856ad364e35_10.0.18362.997_none_b453df19f80f8d5b/f/wpcmon.png | head</span><br><span class="hljs-string">00000000: 400b 0a1a 5041 3330 008b e980 ac49 d601  @...PA30.....I..</span><br><span class="hljs-string">00000010: b07e 4000 00c3 2709 1c00 1402 c30c 6217  .~@...&#x27;.......b.</span><br><span class="hljs-string">00000020: 48c6 6ce7 51b1 9b27 8855 9a3e 010b b103  H.l.Q..&#x27;.U.&gt;....</span><br><span class="hljs-string">00000030: 003c 12               </span><br></code></pre></td></tr></table></figure>

<p>这些不是 PE 或 PNG 文件，并且出现了一种清晰的模式！<code>PA30</code> 在每个文件中从偏移量 <code>4</code> 开始，无论类型是什么。但是前四个字节是什么？在我最初尝试使用 delta 时，我感到很沮丧，因为使用 <code>msdelta.dll</code> 中的任何 <code>ApplyDelta*</code> 函数都会导致错误。对文件格式（PA30）的研究最终使我获得了该技术的<a target="_blank" rel="noopener" href="https://patents.google.com/patent/US20070260653">专利</a>，如果您想看一下，这很有趣，但没有为我的问题提供答案。在真正的 <a target="_blank" rel="noopener" href="https://www.urbandictionary.com/define.php?term=FILDI">FILDI</a> 时刻，我只是切断了前四个字节，因为文件magic通常位于文件的开头（对吗？），令我惊讶的是，增量应用了！太棒了，那 4 个字节是多少？该格式是否记录在任何地方？在思考了我之前遇到的文件中看似无用的字节之后，我想到了一个校验和，特别是我能想到的最常见的 4 字节校验和：<code>CRC32！</code>所以我跳进 <code>ipython</code> 来尝试一下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">In [<span class="hljs-number">1</span>]: <span class="hljs-keyword">import</span> zlib<br><br>In [<span class="hljs-number">2</span>]: data = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;2020-08/patch/amd64_microsoft-windows-f..ysafety-refreshtask_31bf3856ad364e35_10.0.18362.997_none_</span><br><span class="hljs-string">   ...: b453df19f80f8d5b/f/wpcmon.png&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>).read()<br><br>In [<span class="hljs-number">3</span>]: <span class="hljs-built_in">hex</span>(zlib.crc32(data[<span class="hljs-number">4</span>:]))<br>Out[<span class="hljs-number">3</span>]: <span class="hljs-string">&#x27;0x1a0a0b40&#x27;</span><br><br>In [<span class="hljs-number">4</span>]: <span class="hljs-built_in">hex</span>(<span class="hljs-built_in">int</span>.from_bytes(data[:<span class="hljs-number">4</span>], <span class="hljs-string">&#x27;little&#x27;</span>))<br>Out[<span class="hljs-number">4</span>]: <span class="hljs-string">&#x27;0x1a0a0b40&#x27;</span><br></code></pre></td></tr></table></figure>

<p>我的怀疑得到了证实！完全是一个幸运的猜测，而且我能找到的任何地方都没有记录它。</p>
<p>在经历了这个发现之后，我认为这将是一个有趣的 CTF 挑战。所以我为一年一度的 <a target="_blank" rel="noopener" href="http://sparsa.rip/">RITSEC CTF</a> 设计了一个 CTF 挑战赛。它应该被称为 <code>patch-tuesday</code>，但我不小心上传了带有该标志的原始 <code>.sys</code> 文件。该挑战最终被称为 patch-2sday，涉及调用 MSDELTA API 在剥离前置的 CRC32 后修补文件。感谢<a target="_blank" rel="noopener" href="https://twitter.com/layle_ctf">莱尔</a>和元娜是仅有的两个解决了这个问题的人！您可以在 <a target="_blank" rel="noopener" href="https://github.com/ritsec/RITSEC-CTF-2019/tree/master/Misc/patch-tuesday">RITSEC Github</a> 上找到该挑战的解决方案的文章；如果您对此感兴趣，该存储库还包含我用来<a target="_blank" rel="noopener" href="https://github.com/ritsec/RITSEC-CTF-2019/blob/master/Misc/patch-tuesday/make_delta.py">创建增量的脚本</a>。</p>
<h3 id="从-Delta-中生成有用的二进制文件"><a href="#从-Delta-中生成有用的二进制文件" class="headerlink" title="从 Delta 中生成有用的二进制文件"></a><strong>从 Delta 中生成有用的二进制文件</strong></h3><p>假设我有一台 Windows 10 1903 x64 计算机，我想查看 2020 年 <a target="_blank" rel="noopener" href="https://support.microsoft.com/en-us/help/4565483">7</a> 月至 <a target="_blank" rel="noopener" href="https://support.microsoft.com/en-us/help/4565351_">8</a> 月 ntoskrnl.exe 之间的差异。该机器当前安装了 <a target="_blank" rel="noopener" href="https://support.microsoft.com/en-us/help/4524147/windows-10-update-kb4524147_">2019 年 10 月</a>的补丁。我将从 <code>C:\windows\system32</code> 中复制 ntoskrnl.exe 二进制文件，并使用 MSDELTA API 将增量应用于二进制文件以获得我想要的版本。</p>
<h4 id="后退，然后前进"><a href="#后退，然后前进" class="headerlink" title="后退，然后前进"></a><strong>后退，然后前进</strong></h4><p>我拥有的内核二进制文件的版本是 10.0.18362.388。在开始修补之前，我需要此特定版本的反向差分将其回滚到版本 10.0.18362.1。我可以下载并提取 2019 年 10 月更新，但这需要很长时间。回想一下，安装补丁后，Windows Update 会将二进制文件和差异文件放置在 <code>C:\Windows\WinSxS</code> 目录中。您可以运行一些 powershell 来查找系统上已有的增量：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> &gt; <span class="hljs-built_in">Get-ChildItem</span> <span class="hljs-literal">-Recurse</span> C:\windows\WinSxS\ | ? &#123;<span class="hljs-variable">$_</span>.Name <span class="hljs-operator">-eq</span> <span class="hljs-string">&quot;ntoskrnl.exe&quot;</span>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs powershell"> Directory:<br>    C:\windows\WinSxS\amd64_microsoft<span class="hljs-literal">-windows-os-kernel_31bf3856ad364e35_10</span>.<span class="hljs-number">0.18362</span>.<span class="hljs-number">388</span>_none_c1e023dc45da9936<br><br>Mode                LastWriteTime         Length Name<br><span class="hljs-literal">----</span>                <span class="hljs-literal">-------------</span>         <span class="hljs-literal">------</span> <span class="hljs-literal">----</span><br><span class="hljs-literal">-a---l</span>        <span class="hljs-number">10</span>/<span class="hljs-number">4</span>/<span class="hljs-number">2019</span>   <span class="hljs-number">6</span>:<span class="hljs-number">06</span> AM        <span class="hljs-number">9928720</span> ntoskrnl.exe<br><br><br>    Directory:<br>    C:\windows\WinSxS\amd64_microsoft<span class="hljs-literal">-windows-os-kernel_31bf3856ad364e35_10</span>.<span class="hljs-number">0.18362</span>.<span class="hljs-number">388</span>_none_c1e023dc45da9936\f<br><br><br>Mode                LastWriteTime         Length Name<br><span class="hljs-literal">----</span>                <span class="hljs-literal">-------------</span>         <span class="hljs-literal">------</span> <span class="hljs-literal">----</span><br><span class="hljs-literal">-a----</span>        <span class="hljs-number">9</span>/<span class="hljs-number">30</span>/<span class="hljs-number">2019</span>   <span class="hljs-number">6</span>:<span class="hljs-number">39</span> PM         <span class="hljs-number">479646</span> ntoskrnl.exe<br><br><br>    Directory:<br>    C:\windows\WinSxS\amd64_microsoft<span class="hljs-literal">-windows-os-kernel_31bf3856ad364e35_10</span>.<span class="hljs-number">0.18362</span>.<span class="hljs-number">388</span>_none_c1e023dc45da9936\r<br><br><br>Mode                LastWriteTime         Length Name<br><span class="hljs-literal">----</span>                <span class="hljs-literal">-------------</span>         <span class="hljs-literal">------</span> <span class="hljs-literal">----</span><br><span class="hljs-literal">-a----</span>        <span class="hljs-number">9</span>/<span class="hljs-number">30</span>/<span class="hljs-number">2019</span>   <span class="hljs-number">6</span>:<span class="hljs-number">39</span> PM         <span class="hljs-number">476929</span> ntoskrnl.exe<br></code></pre></td></tr></table></figure>
<p>完整版本以及前进和后退差速器都存在。现在我拥有执行增量所需的所有文件并获取我想要比较的两个版本的内核！</p>
<h4 id="使用-MSDELTA-API-应用补丁增量"><a href="#使用-MSDELTA-API-应用补丁增量" class="headerlink" title="使用 MSDELTA API 应用补丁增量"></a><strong>使用 MSDELTA API 应用补丁增量</strong></h4><p>我决定编写一个 python 程序来与 <code>msdelta.dll</code> 交互并调用 <code>ApplyDelta</code> 系列函数。如果您以前从未使用过 python <code>ctypes</code>，那么该脚本一开始可能看起来有点奇怪，但我保证它是您实用工具带中的一个非常强大的工具。除此之外，ctypes 可以充当 C 的<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Foreign_function_interface">外部函数</a>接口；它允许您调用 DLL 内部的函数、创建结构和联合、原始缓冲区，并实现了许多基本类型，例如 <code>c_uint64</code>、<code>c_char_p</code>,以及 Windows 类型，例如 <code>DWORD</code>、<code>HANDLE</code> 和 <code>LPVOID</code>。</p>
<p>如果您对 ctypes 的更多用途感兴趣，请查看我关于<a target="_blank" rel="noopener" href="https://wumb0.in/a-better-way-to-work-with-raw-data-types-in-python.html">有效使用 ctypes 结构的文章</a>，但请记住它是为 python 2.7 编写的，并且可能需要更改示例以支持 python 3。</p>
<p>下面是为 python 3 编写的最终补丁增量应用脚本（单击文件名展开）。它使用所有 python 内置函数，您需要在 Windows 系统上运行它，因为它导入 <code>msdelta.dll</code> 并使用 <code>ApplyDeltaB</code> 来应用补丁。它甚至支持旧版 PatchAPI 补丁 (<code>PA19</code>)。</p>
<p><a target="_blank" rel="noopener" href="https://gist.github.com/wumb0/9542469e3915953f7ae02d63998d2553#file-delta_patch-py">delta_patch.py</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> (windll, wintypes, c_uint64, cast, POINTER, <span class="hljs-type">Union</span>, c_ubyte,<br>                    LittleEndianStructure, byref, c_size_t)<br><span class="hljs-keyword">import</span> zlib<br><br><br><span class="hljs-comment"># types and flags</span><br>DELTA_FLAG_TYPE             = c_uint64<br>DELTA_FLAG_NONE             = <span class="hljs-number">0x00000000</span><br>DELTA_APPLY_FLAG_ALLOW_PA19 = <span class="hljs-number">0x00000001</span><br><br><br><span class="hljs-comment"># structures</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DELTA_INPUT</span>(<span class="hljs-title class_ inherited__">LittleEndianStructure</span>):<br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">U1</span>(<span class="hljs-title class_ inherited__">Union</span>):<br>        _fields_ = [(<span class="hljs-string">&#x27;lpcStart&#x27;</span>, wintypes.LPVOID),<br>                    (<span class="hljs-string">&#x27;lpStart&#x27;</span>, wintypes.LPVOID)]<br>    _anonymous_ = (<span class="hljs-string">&#x27;u1&#x27;</span>,)<br>    _fields_ = [(<span class="hljs-string">&#x27;u1&#x27;</span>, U1),<br>                (<span class="hljs-string">&#x27;uSize&#x27;</span>, c_size_t),<br>                (<span class="hljs-string">&#x27;Editable&#x27;</span>, wintypes.BOOL)]<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DELTA_OUTPUT</span>(<span class="hljs-title class_ inherited__">LittleEndianStructure</span>):<br>    _fields_ = [(<span class="hljs-string">&#x27;lpStart&#x27;</span>, wintypes.LPVOID),<br>                (<span class="hljs-string">&#x27;uSize&#x27;</span>, c_size_t)]<br><br><br><span class="hljs-comment"># functions</span><br>ApplyDeltaB = windll.msdelta.ApplyDeltaB<br>ApplyDeltaB.argtypes = [DELTA_FLAG_TYPE, DELTA_INPUT, DELTA_INPUT,<br>                        POINTER(DELTA_OUTPUT)]<br>ApplyDeltaB.rettype = wintypes.BOOL<br>DeltaFree = windll.msdelta.DeltaFree<br>DeltaFree.argtypes = [wintypes.LPVOID]<br>DeltaFree.rettype = wintypes.BOOL<br>gle = windll.kernel32.GetLastError<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">apply_patchfile_to_buffer</span>(<span class="hljs-params">buf, buflen, patchpath, legacy</span>):<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(patchpath, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> patch:<br>        patch_contents = patch.read()<br><br>    <span class="hljs-comment"># most (all?) patches (Windows Update MSU) come with a CRC32 prepended to the file</span><br>    <span class="hljs-comment"># we don&#x27;t really care if it is valid or not, we just need to remove it if it is there</span><br>    <span class="hljs-comment"># we only need to calculate if the file starts with PA30 or PA19 and then has PA30 or PA19 after it</span><br>    magic = [<span class="hljs-string">b&quot;PA30&quot;</span>]<br>    <span class="hljs-keyword">if</span> legacy:<br>        magic.append(<span class="hljs-string">b&quot;PA19&quot;</span>)<br>    <span class="hljs-keyword">if</span> patch_contents[:<span class="hljs-number">4</span>] <span class="hljs-keyword">in</span> magic <span class="hljs-keyword">and</span> patch_contents[<span class="hljs-number">4</span>:][:<span class="hljs-number">4</span>] <span class="hljs-keyword">in</span> magic:<br>        <span class="hljs-comment"># we have to validate and strip the crc instead of just stripping it</span><br>        crc = <span class="hljs-built_in">int</span>.from_bytes(patch_contents[:<span class="hljs-number">4</span>], <span class="hljs-string">&#x27;little&#x27;</span>)<br>        <span class="hljs-keyword">if</span> zlib.crc32(patch_contents[<span class="hljs-number">4</span>:]) == crc:<br>            <span class="hljs-comment"># crc is valid, strip it, else don&#x27;t</span><br>            patch_contents = patch_contents[<span class="hljs-number">4</span>:]<br>    <span class="hljs-keyword">elif</span> patch_contents[<span class="hljs-number">4</span>:][:<span class="hljs-number">4</span>] <span class="hljs-keyword">in</span> magic:<br>        <span class="hljs-comment"># validate the header strip the CRC, we don&#x27;t care about it</span><br>        patch_contents = patch_contents[<span class="hljs-number">4</span>:]<br>    <span class="hljs-comment"># check if there is just no CRC at all</span><br>    <span class="hljs-keyword">elif</span> patch_contents[:<span class="hljs-number">4</span>] <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> magic:<br>        <span class="hljs-comment"># this just isn&#x27;t valid</span><br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&quot;Patch file is invalid&quot;</span>)<br> <br>    applyflags = DELTA_APPLY_FLAG_ALLOW_PA19 <span class="hljs-keyword">if</span> legacy <span class="hljs-keyword">else</span> DELTA_FLAG_NONE<br><br>    dd = DELTA_INPUT()<br>    ds = DELTA_INPUT()<br>    dout = DELTA_OUTPUT()<br><br>    ds.lpcStart = buf<br>    ds.uSize = buflen<br>    ds.Editable = <span class="hljs-literal">False</span><br><br>    dd.lpcStart = cast(patch_contents, wintypes.LPVOID)<br>    dd.uSize = <span class="hljs-built_in">len</span>(patch_contents)<br>    dd.Editable = <span class="hljs-literal">False</span><br><br>    status = ApplyDeltaB(applyflags, ds, dd, byref(dout))<br>    <span class="hljs-keyword">if</span> status == <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&quot;Patch &#123;&#125; failed with error &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(patchpath, gle()))<br><br>    <span class="hljs-keyword">return</span> (dout.lpStart, dout.uSize)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-keyword">import</span> sys<br>    <span class="hljs-keyword">import</span> base64<br>    <span class="hljs-keyword">import</span> hashlib<br>    <span class="hljs-keyword">import</span> argparse<br><br>    ap = argparse.ArgumentParser()<br>    mode = ap.add_mutually_exclusive_group(required=<span class="hljs-literal">True</span>)<br>    output = ap.add_mutually_exclusive_group(required=<span class="hljs-literal">True</span>)<br>    mode.add_argument(<span class="hljs-string">&quot;-i&quot;</span>, <span class="hljs-string">&quot;--input-file&quot;</span>,<br>                      <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;File to patch (forward or reverse)&quot;</span>)<br>    mode.add_argument(<span class="hljs-string">&quot;-n&quot;</span>, <span class="hljs-string">&quot;--null&quot;</span>, action=<span class="hljs-string">&quot;store_true&quot;</span>, default=<span class="hljs-literal">False</span>,<br>                      <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;Create the output file from a null diff &quot;</span><br>                           <span class="hljs-string">&quot;(null diff must be the first one specified)&quot;</span>)<br>    output.add_argument(<span class="hljs-string">&quot;-o&quot;</span>, <span class="hljs-string">&quot;--output-file&quot;</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;Destination to write patched file to&quot;</span>)<br>    output.add_argument(<span class="hljs-string">&quot;-d&quot;</span>, <span class="hljs-string">&quot;--dry-run&quot;</span>, action=<span class="hljs-string">&quot;store_true&quot;</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;Don&#x27;t write patch, just see if it would patch&quot;</span><br>                             <span class="hljs-string">&quot;correctly and get the resulting hash&quot;</span>)<br>    ap.add_argument(<span class="hljs-string">&quot;-l&quot;</span>, <span class="hljs-string">&quot;--legacy&quot;</span>, action=<span class="hljs-string">&#x27;store_true&#x27;</span>, default=<span class="hljs-literal">False</span>,<br>                    <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;Let the API use the PA19 legacy API (if required)&quot;</span>)<br>    ap.add_argument(<span class="hljs-string">&quot;patches&quot;</span>, nargs=<span class="hljs-string">&#x27;+&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;Patches to apply&quot;</span>)<br>    args = ap.parse_args()<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> args.dry_run <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> args.output_file:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Either specify -d or -o&quot;</span>, file=sys.stderr)<br>        ap.print_help()<br>        sys.exit(<span class="hljs-number">1</span>)<br><br>    <span class="hljs-keyword">if</span> args.null:<br>        inbuf = <span class="hljs-string">b&quot;&quot;</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(args.input_file, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> r:<br>            inbuf = r.read()<br><br>    buf = cast(inbuf, wintypes.LPVOID)<br>    n = <span class="hljs-built_in">len</span>(inbuf)<br>    to_free = []<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">for</span> patch <span class="hljs-keyword">in</span> args.patches:<br>            buf, n = apply_patchfile_to_buffer(buf, n, patch, args.legacy)<br>            to_free.append(buf)<br><br>        outbuf = <span class="hljs-built_in">bytes</span>((c_ubyte*n).from_address(buf))<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> args.dry_run:<br>            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(args.output_file, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> w:<br>                w.write(outbuf)<br>    <span class="hljs-keyword">finally</span>:<br>        <span class="hljs-keyword">for</span> buf <span class="hljs-keyword">in</span> to_free:<br>            DeltaFree(buf)<br><br>    finalhash = hashlib.sha256(outbuf)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Applied &#123;&#125; patch&#123;&#125; successfully&quot;</span><br>          .<span class="hljs-built_in">format</span>(<span class="hljs-built_in">len</span>(args.patches), <span class="hljs-string">&quot;es&quot;</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(args.patches) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;&quot;</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Final hash: &#123;&#125;&quot;</span><br>          .<span class="hljs-built_in">format</span>(base64.b64encode(finalhash.digest()).decode()))<br></code></pre></td></tr></table></figure>
<p>这是该程序的用法的打印输出，因此您可以了解它提供的功能以及如何使用它。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> &gt; python X:\Patches\tools\delta_patch.py <span class="hljs-literal">-h</span><br>usage: delta_patch.py [-<span class="hljs-type">h</span>] (<span class="hljs-literal">-i</span> INPUT_FILE | <span class="hljs-literal">-n</span>) (<span class="hljs-literal">-o</span> OUTPUT_FILE | <span class="hljs-literal">-d</span>) [-<span class="hljs-type">l</span>] patches [<span class="hljs-type">patches</span> <span class="hljs-type">...</span>]<br><br>positional arguments:<br>  patches               Patches to apply<br><br>optional arguments:<br>  <span class="hljs-literal">-h</span>, <span class="hljs-literal">--help</span>            show this help message and <span class="hljs-keyword">exit</span><br>  <span class="hljs-literal">-i</span> INPUT_FILE, <span class="hljs-literal">--input-file</span> INPUT_FILE<br>                        File to patch (forward or reverse)<br>  <span class="hljs-literal">-n</span>, <span class="hljs-literal">--null</span>            Create the output file from a null <span class="hljs-built_in">diff</span> (null <span class="hljs-built_in">diff</span> must be the first one specified)<br>  <span class="hljs-literal">-o</span> OUTPUT_FILE, <span class="hljs-literal">--output-file</span> OUTPUT_FILE<br>                        Destination to <span class="hljs-built_in">write</span> patched file to<br>  <span class="hljs-literal">-d</span>, <span class="hljs-literal">--dry-run</span>         Don<span class="hljs-string">&#x27;t write patch, just see if it would patchcorrectly and get the resulting hash</span><br><span class="hljs-string">  -l, --legacy          Let the API use the PA19 legacy API (if required)</span><br></code></pre></td></tr></table></figure>

<p>为了生成我想要的二进制文件，我将应用反向增量，然后应用每个正向增量，创建两个输出文件：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> &gt; python X:\Patches\tools\delta_patch.py <span class="hljs-literal">-i</span> ntoskrnl.exe <span class="hljs-literal">-o</span> ntoskrnl.<span class="hljs-number">2020</span><span class="hljs-literal">-07</span>.exe .\r\ntoskrnl.exe X:\Patches\x64\<span class="hljs-number">1903</span>\<span class="hljs-number">2020</span>\<span class="hljs-number">2020</span><span class="hljs-literal">-07</span>\x64\os<span class="hljs-literal">-kernel_10</span>.<span class="hljs-number">0.18362</span>.<span class="hljs-number">959</span>\f\ntoskrnl.exe<br><br>Applied <span class="hljs-number">2</span> patches successfully<br>Final hash: zZC/JZ+y5ZLrqTvhRVNf1/<span class="hljs-number">79</span>C4ZYwXgmZ+DZBMoq8ek=<br></code></pre></td></tr></table></figure>


<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> &gt; python X:\Patches\tools\delta_patch.py <span class="hljs-literal">-i</span> ntoskrnl.exe <span class="hljs-literal">-o</span> ntoskrnl.<span class="hljs-number">2020</span><span class="hljs-literal">-08</span>.exe .\r\ntoskrnl.exe X:\Patches\x64\<span class="hljs-number">1903</span>\<span class="hljs-number">2020</span>\<span class="hljs-number">2020</span><span class="hljs-literal">-08</span>\x64\os<span class="hljs-literal">-kernel_10</span>.<span class="hljs-number">0.18362</span>.<span class="hljs-number">1016</span>\f\ntoskrnl.exe<br><br>Applied <span class="hljs-number">2</span> patches successfully<br>Final hash: UZw7bE231NL2R0S4yBNT1nmDW8PQ83u9rjp91AiCrUQ=<br></code></pre></td></tr></table></figure>

<p>补丁已成功应用，现在我有两个完整的二进制文件，一个来自 2020 年 8 月的补丁集，另一个来自 2020 年 7 月。生成的哈希值应与相应清单文件中的哈希值匹配！</p>
<h4 id="空差异怎么样？"><a href="#空差异怎么样？" class="headerlink" title="空差异怎么样？"></a><strong>空差异怎么样？</strong></h4><p>在继续比较两个内核版本之前，我想解释如何使用 delta_patch 工具从 null (n) 差异中生成完整文件。有一个内置选项！使用 <code>-n</code> 标志并指定输出文件（但没有输入文件），并且 delta_patch 会将增量应用到空缓冲区。结果是完整的文件！</p>
<p>例如：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> &gt; python X:\Patches\tools\delta_patch.py <span class="hljs-literal">-n</span> <span class="hljs-literal">-o</span> vmcomputeagent.exe  <span class="hljs-number">2020</span><span class="hljs-literal">-08</span>\patch\amd64_hyperv<span class="hljs-literal">-compute-guestcomputeservice_31bf3856ad364e35_10</span>.<span class="hljs-number">0.18362</span>.<span class="hljs-number">329</span>_none_e3769ae1a46d95f1\n\vmcomputeagent.exe<br>Applied <span class="hljs-number">1</span> patch successfully<br>Final hash: B5mZQ8i4OU22UQXOaDhLHNtLNhos6exfTHlsPzTmXGo=<br><span class="hljs-built_in">PS</span> &gt; wsl <span class="hljs-literal">-e</span> file vmcomputeagent.exe<br>vmcomputeagent.exe: PE32+ executable (GUI) x86<span class="hljs-literal">-64</span>, <span class="hljs-keyword">for</span> MS Windows<br></code></pre></td></tr></table></figure>

<p>从文件的输出中可以看到，零差异已扩展为完整的可执行文件。当然，您还可以应用前向差分，但只能在空差分之后应用，否则您将没有文件可以修补！</p>
<h1 id="补丁比较"><a href="#补丁比较" class="headerlink" title="补丁比较"></a><strong>补丁比较</strong></h1><p>有大量关于二进制比较和<a target="_blank" rel="noopener" href="https://malware.news/t/comparative-analysis-between-bindiff-and-diaphora-patched-smokeloader-study-case/40996">比较工具</a>的资源<a target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2017/10/using-binary-diffing-to-discover.html">1</a>,<a target="_blank" rel="noopener" href="https://beistlab.files.wordpress.com/2012/10/isec_2012_beist_slides.pdf">2</a>,<a target="_blank" rel="noopener" href="https://wumb0.in/extracting-and-diffing-ms-patches-in-2020.html">3</a>,<a target="_blank" rel="noopener" href="https://www.slideshare.net/cisoplatform7/bruh-do-you-even-diffdiffing-microsoft-patches-to-find-vulnerabilities">4</a>,<a target="_blank" rel="noopener" href="https://apprize.best/security/ethical_1/20.html">5</a>, <a target="_blank" rel="noopener" href="http://joxeankoret.com/blog/2015/03/13/diaphora-a-program-diffing-plugin-for-ida-pro/">6</a>,<a target="_blank" rel="noopener" href="https://deadlisting.com/files/Sims_Patch_Diff_BSides_Baltimore.pdf">7</a>，因此我不会深入研究如何使用它们，但为了完整起见，我将比较我刚刚创建的两个内核！</p>
<p>我将在 IDA Pro 7.5 中打开两个版本的 ntoskrnl.exe，接受符号下载提示，然后让自动分析完成。然后，我将关闭两个版本中较新的版本 (2020-08) 并调用 <a target="_blank" rel="noopener" href="https://www.zynamics.com/bindiff.html">BinDiff</a> 将新版本（次要版本）与旧版本（主要版本）进行比较。</p>
<p><img src="/2023/07/06/Windows%20%E8%A1%A5%E4%B8%81%E7%9A%84%E6%8F%90%E5%8F%96%E5%92%8C%E6%AF%94%E8%BE%83/patchdiff-matched-functions.png" srcset="/img/loading.gif" lazyload alt="There are only a few changed functions between the two versions"></p>
<p>我将查看 <code>MmDuplicateMemory</code>，因为与内存相关的函数的变化总是引起我的注意！下面是 BinDiff 中组合调用图的概述。绿色块没有变化，黄色块有差异，红色块被补丁删除，灰色块被补丁添加。</p>
<p><img src="/2023/07/06/Windows%20%E8%A1%A5%E4%B8%81%E7%9A%84%E6%8F%90%E5%8F%96%E5%92%8C%E6%AF%94%E8%BE%83/bindiff-overview.png" srcset="/img/loading.gif" lazyload alt="Graph overview with BinDiff in combined mode"></p>
<p>有很多变化，但我想突出显示一个块，特别是靠近函数顶部的块（由红色箭头表示）：</p>
<p><img src="/2023/07/06/Windows%20%E8%A1%A5%E4%B8%81%E7%9A%84%E6%8F%90%E5%8F%96%E5%92%8C%E6%AF%94%E8%BE%83/bindiff-changed-block.png" srcset="/img/loading.gif" lazyload alt="Can you spot the important change?"></p>
<p>看起来未修补的版本中未检查函数 <code>KeWaitForSingleObject</code> 的返回值，并且修补程序添加了一项检查以确保该函数返回值 0 (<code>WAIT_OBJECT_0</code>)。在判断这个bug的严重性方面，需要做更多的工作来调查什么可等待对象被传递给<code>KeWaitForSingleObject（cs：[0x1404681D0]）</code>，是否有任何方法可以让等待可靠地失败，以及该失败会导致什么行为。这是留给读者的练习。</p>
<h1 id="Wrap-Up"><a href="#Wrap-Up" class="headerlink" title="Wrap Up"></a><strong>Wrap Up</strong></h1><p>感谢您坚持到最后。我希望你学到了一两件事。如果您有疑问、意见、疑虑、投诉或更正，请随时与我联系。我的推特账号是<a target="_blank" rel="noopener" href="https://twitter.com/jgeigerm">@jgeigerm</a>。如果脚本损坏，也要联系他们，他们不应该这样做。以后我会尝试发布更多Windows相关内容，敬请期待。我希望有一天能在 <a target="_blank" rel="noopener" href="https://www.sans.org/cyber-security-courses/advanced-exploit-development-penetration-testers/">SEC760</a> 见到你！我最近重写了内核开发日，教学非常精彩！</p>
<p>Tags: <a target="_blank" rel="noopener" href="https://wumb0.in/tag/patch-diff/">patch-diff</a>  <a target="_blank" rel="noopener" href="https://wumb0.in/tag/vr/">VR</a>  <a target="_blank" rel="noopener" href="https://wumb0.in/tag/bindiff/">bindiff</a>  <a target="_blank" rel="noopener" href="https://wumb0.in/tag/patch-delta/">patch-delta</a> </p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%9D%82%E4%B8%83%E6%9D%82%E5%85%AB/" class="category-chain-item">杂七杂八</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Windows 补丁的提取和比较</div>
      <div>https://xxxxnnxxxx.github.io/2023/07/06/Windows 补丁的提取和比较/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>xxxxnnxxxx</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年7月6日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/07/06/StackOverflow/" title="StackOverflow">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">StackOverflow</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/07/05/%E6%A0%88%E7%9B%B8%E5%85%B3%E6%A3%80%E6%9F%A5/" title="栈相关检查">
                        <span class="hidden-mobile">栈相关检查</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>





  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
